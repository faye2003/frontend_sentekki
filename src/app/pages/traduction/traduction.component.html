<app-pagetitle class=" font-size-16" title="Traducteur" [breadcrumbItems]="breadCrumbItems"></app-pagetitle>
<div class="translator-wrapper mb-5">

  <div class="row g-4">

    <!-- Zone INPUT (texte source) -->
    <div class="col-lg-6">
      <div class="translator-card">

        <!-- Header : choix langue source -->
        <div class="translator-header justify-content-between">
          <select class="form-select form-select-sm">
            <!-- <option>DÃ©tecter la langue</option> -->
            <option>FranÃ§ais</option>
            <option>Anglais</option>
            <option>Espagnol</option>
            <option>Allemand</option>
          </select>

          <button class="swap-btn">
            <i class="mdi mdi-swap-horizontal"></i>
          </button>
        </div>

        <!-- Bouton vider -->
          <button
            *ngIf="inputText && inputText.trim() !== ''"
            type="button"
            class="btn btn-close p-1 btn-outline-secondary bg-primary position-absolute end-0 m-2"
            (click)="clearInput()"
            title="Vider"
          ></button>

        <!-- Zone de texte -->
        <textarea
          class="translator-textarea"
          #autoResizeTextarea
          [(ngModel)]="inputText"
          (input)="onTextChange()"
          rows="6"
          placeholder="Saisissez le texte..."
        ></textarea>

        <div class="d-flex justify-content-md-end text-muted small px-1">
            <span>{{ charCount }}/5000 caractÃ¨res</span>
        </div>
        <!-- Footer : actions audio -->
        <div class="translator-footer">
          <div class="d-flex align-items-center gap-3">
            <button class="icon-btn">
              <i class="mdi mdi-microphone-outline"></i>
            </button>

            <button class="icon-btn">
              <i class="mdi mdi-volume-high"></i>
            </button>

            <button class="icon-btn ms-auto"
            *ngIf="translatedText && translatedText.trim() !== ''"
            (click)="copyOutput()"
            title="Copier">
              <i class="mdi mdi-content-copy"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Bouton pour afficher les 10 derniers tranduction de l'utilisateur connectÃ© -->
        <div class="row mt-2">
            <div class="col text-center justify-content-center">
              <!-- Bouton traduire -->
              <button class="btn btn-outline-primary px-5 py-2 shadow-sm btn-traduire" (click)="onTranslate()">
                  <i class="fa-solid fa-right-left"></i> Tranduire
              </button>
            </div>
        </div>
    </div>

    <!-- Zone OUTPUT (texte traduit) -->
    <div class="col-lg-6">
      <div class="translator-card">

        <!-- Header : choix langue cible -->
        <div class="translator-header">
          <select class="form-select form-select-sm">
            <option>Anglais</option>
            <option>FranÃ§ais</option>
            <option>Espagnol</option>
            <option>Allemand</option>
          </select>
        </div>

        <!-- Zone rÃ©sultat -->
         
        <div class="translated-output">
            <div *ngIf="loading">
                <div class="spinner-grow spinner-grow-sm" role="status">
                <span class="visually-hidden">Loading...</span>
                </div>
                <div class="spinner-grow spinner-grow-sm" role="status">
                <span class="visually-hidden">Loading...</span>
                </div>
                <div class="spinner-grow spinner-grow-sm" role="status">
                <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div *ngIf="!loading && translatorData">
                <ng-container *ngFor="let sentence of translatorData.output_sentence; let i = index">
                <a href="javascript:void(0);"
                    *ngIf="hasRole('super_admin','corrector','admin')"
                    (click)="handleSentenceClick(sentence)">
                    {{ sentence.isEditing ? sentence.editText : sentence.text || "Traduction..." }}
                </a>
                <a href="javascript:void(0);"
                    *ngIf="!userRole || userRole === 'translator'">
                    {{ sentence.isEditing ? sentence.editText : sentence.text || "Traduction..." }}
                </a>
                </ng-container>
            </div>
        </div>
        <!-- <textarea
          class="translator-textarea bg-light"
          rows="6"
          placeholder="Traduction..."
          readonly
        ></textarea> -->

        <!-- Footer : actions audio -->
        <div class="translator-footer">
          <div class="d-flex align-items-center gap-3">
            <button class="icon-btn">
              <i class="mdi mdi-volume-high"></i>
            </button>

            <button class="icon-btn ms-auto"
            (click)="copyOutput()"
            *ngIf="translatedText && translatedText.trim() !== ''"
            title="Copier">
              <i class="mdi mdi-content-copy"></i>
            </button>
          </div>
        </div>
      </div>
      <!-- Bouton pour afficher les 10 derniers tranduction de l'utilisateur connectÃ© -->
        <div class="row mt-2" *ngIf="userRole === 'super_admin' || userRole === 'translator' || userRole === 'corrector' || userRole === 'admin'">
            <div class="col text-center justify-content-center">
            <button class="btn btn-rounded shadow-sm history" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" (click)="openRight(Rightcontent)">
                <i class="fas fa-history"></i>
            </button>
            <p><span class="text-secondary span-history fw-medium font-size-16">Historique</span></p>
            <!-- <h6>Historique</h6> -->
            </div>
        </div>
    </div>

</div>

</div>

<div class="card border-0 shadow-sm mt-4" *ngIf="translations.length > 0">
  <div class="card-body">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h6 class="fw-semibold mb-0">ðŸ•˜ Historique des traductions</h6>

      <div class="d-flex gap-2 align-items-center">
        <!-- ðŸ” FILTRE -->
        <input
          type="text"
          class="form-control form-control-sm search-history"
          placeholder="Rechercher dans lâ€™historique..."
          [(ngModel)]="historySearch"
          (input)="filterHistory()"
        />

        <!-- ðŸ—‘ï¸ BOUTON EFFACER -->
        <button 
          class="btn btn-sm btn-outline-danger d-flex align-items-center gap-1"
          (click)="clearHistory()"
        >
          <i class="mdi mdi-delete-outline"></i>
          Effacer
        </button>
      </div>
    </div>

    <div class="list-group">
      <a 
        *ngFor="let item of translations; let i = index"
        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
        (click)="loadFromHistory(i)"
      >
        <div>
          <strong>{{ item.input_text }}</strong>
          <p class="mb-0 text-muted small">{{ item.output_text }}</p>
            <!-- Affichage de la note si elle existe -->
            <div *ngIf="item.rate && item.rate > 0" class="mt-1">
                <ngb-rating [rate]="item.rate" [readonly]="true" [max]="5"></ngb-rating>
                <small class="text-muted ms-2">{{ item.mention }}</small>
            </div>
        </div>

        <small class="text-muted">{{ item.created_at | date:'short' }}</small>
      </a>
    </div>

    <p class="text-muted small text-end mt-2 mb-0">
      {{ filteredHistory.length }} Ã©lÃ©ment(s)
    </p>

  </div>
</div>

<!-- Modal Correction -->
<ng-template #content role="document" let-modal>
  <div class="modal-header border-bottom-0">
    <h5 class="modal-title mt-0 ">Corriger la traduction</h5>
    <button type="button" class="btn-close" (click)="closeModal('Cross click')"></button>
  </div>
  <div class="modal-body">
      <div class="row m-2">
        <ul *ngIf="translatorData">
          <li *ngFor="let s of translatorData.output_sentence">
            <span *ngIf="!s.isEditing">{{ s.text }}</span>
            <input *ngIf="s.isEditing" [(ngModel)]="s.editText" class="form-control" (keyup.enter)="saveCorrection(s)">
            <button class="btn btn-sm"
                  *ngIf="!s.isEditing"
                  (click)="editSentence(s)">
              <i class="fas fa-edit"></i>
            </button>
            <div class="row mt-2">
              <div class="text-end col-md-6">
                <button *ngIf="s.isEditing" (click)="cancelEdit(s)" type="reset" class="btn btn-danger" id="btn-save-event">
                  Annuler
                </button>
              </div>

              <div class="text-start col-md-6">
                <button *ngIf="s.isEditing" (click)="openModal(confirmation)" onclick="refreshPage()" type="submit"
                  class="btn btn-primary button-envoyer px-1 rounded-2 d-flex justify-content-center">
                  <span *ngIf="!isSubmitted">Enregistrer</span>
                </button>
              </div>
            </div>
          </li>
        </ul>
      </div>
  </div>
</ng-template>

<!-- Modal de confirmation -->
<ng-template #confirmation role="document" let-modal>
  <div class="modal-header">
    <h2 class="modal-title mt-0">Confirmation</h2>
    <button type="button" class="btn-close" aria-hidden="true" (click)="closeModal('Cross click')"></button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-12">
        <p>
          <span>Voulez-vous confirmer la correction de la phrase ? </span>
          <span class="text-sonatel fw-bold ml-2"></span>
        </p>
      </div>
    </div>
    <div class="mb-2" *ngIf="error">
      <div class="text-danger" style="font-size: 12px;">{{error}}</div>
    </div>
    <div class="row">
      <div class="text-end col-md-6">
        <button (click)="closeModal('Cross click')" class="btn btn-dark" id="btn-save-event">
          Annuler
        </button>
      </div>
      <div class="text-start col-md-6">
        <button (click)="ConfirmCorrection()" type="submit" class="btn btn-primary" id="btn-save-event">
          Confirmer
        </button>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ratingModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Ã‰valuer la traduction</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body text-center">
    <p class="mb-3">
      Que pensez-vous de cette traduction ?
    </p>

    <!-- â­ SystÃ¨me de notation -->
    <ngb-rating 
      [(rate)]="currentRate"
      [max]="5"
      (rateChange)="onUserRate($event)"
    ></ngb-rating>

    <p class="mt-2 text-muted small">
      Vous pouvez ignorer si vous ne souhaitez pas noter.
    </p>
  </div>

  <div class="modal-footer">
    <button class="btn btn-outline-secondary" (click)="modal.dismiss()">
      Ignorer
    </button>
  </div>
</ng-template>

<div class="table-responsive">
    <table class="table mb-0">
        <tbody>
            <tr>
                <td>Default alert</td>
                <td><a href="javascript: void(0);" id="alert-message" class="btn btn-primary btn-sm waves-effect waves-light" (click)="showStandard()">Click me</a></td>
            </tr>
            <tr>
                <td>Success alert</td>
                <td><a href="javascript: void(0);" id="alert-success" class="btn btn-primary btn-sm waves-effect waves-light" (click)="showSuccess()">Click me</a></td>
            </tr>
            <tr>
                <td>Error alert</td>
                <td><a href="javascript: void(0);" id="alert-error" class="btn btn-primary btn-sm waves-effect waves-light" (click)="showDanger()">Click me</a></td>
            </tr>
            <tr>
                <td>Warning alert</td>
                <td><a href="javascript: void(0);" id="alert-warning" class="btn btn-primary btn-sm waves-effect waves-light" (click)="showWarning()">Click me</a></td>
            </tr>
        </tbody>
    </table>

    <ng-template #dangerTpl>
        <svg xmlns="http://www.w3.org/2000/svg" fill="#fff" width="24" height="24" viewBox="0 0 24 24">
            <path d="M10.872 6.831l1.695 3.904 3.654-1.561-1.79 3.426 3.333.954-3.417 1.338 2.231 4.196-4.773-2.582-2.869 2.287.413-3.004-3.792-.726 2.93-1.74-1.885-2.512 3.427.646.843-4.626zm-.786-6.831l-1.665 9.119-6.512-1.228 3.639 4.851-5.548 3.294 7.108 1.361-.834 6.076 5.742-4.577 9.438 5.104-4.288-8.064 6.834-2.677-6.661-1.907 3.25-6.22-6.98 2.982-3.523-8.114z" />
        </svg>
        Danger Danger !
    </ng-template>

    <app-toasts aria-live="polite" aria-atomic="true"></app-toasts>

</div>

<!-- <ng-template #dangerTpl>
    <svg xmlns="http://www.w3.org/2000/svg" fill="#fff" width="24" height="24" viewBox="0 0 24 24">
        <path d="M10.872 6.831l1.695 3.904 3.654-1.561-1.79 3.426 3.333.954-3.417 1.338 2.231 4.196-4.773-2.582-2.869 2.287.413-3.004-3.792-.726 2.93-1.74-1.885-2.512 3.427.646.843-4.626zm-.786-6.831l-1.665 9.119-6.512-1.228 3.639 4.851-5.548 3.294 7.108 1.361-.834 6.076 5.742-4.577 9.438 5.104-4.288-8.064 6.834-2.677-6.661-1.907 3.25-6.22-6.98 2.982-3.523-8.114z" />
    </svg>
    Danger Danger !
</ng-template> -->

<!-- <app-toasts aria-live="polite" aria-atomic="true"></app-toasts> -->


<!-- Offcanvas Historique -->
<ng-template #Rightcontent let-offcanvas>
  <div class="offcanvas-header border-bottom bg-light">
    <h5 class="fw-semibold mb-0">
      <i class="bi bi-clock-history me-2 text-primary"></i> Historique
    </h5>
    <a type="button" class="btn btn-outline-secondary m-4 font-size-16" [routerLink]="['/historique']" (click)="offcanvas.dismiss('Cross click')">plus</a>
    <button type="button" class="btn-close" (click)="offcanvas.dismiss('Cross click')"></button>
  </div>

  <div class="offcanvas-body p-3">
    <div *ngIf="translations?.length === 0" class="text-center text-muted py-5">
      <i class="bi bi-translate display-6 d-block mb-2 text-secondary"></i>
      <p>Aucune traduction enregistrÃ©e</p>
    </div>

    <div *ngIf="translations?.length && translations.length > 0" class="list-group rounded-3 shadow-sm">
      <div *ngFor="let t of translations" class="list-group-item list-group-item-action py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-semibold text-primary">{{ t.lang_src.name }} â†’ {{ t.lang_dest.name }}</h6>
          <small class="text-muted">{{ t.created_at | date:'short' }}</small>
        </div>
        <p class="mb-1 text-dark small">{{ t.input_text }}</p>
        <p class="text-secondary small">{{ t.output_text }}</p>

        <!-- Note -->
        <!-- <div class="mt-2">
          <ng-template #starTemplate let-fill="fill">
            <span class="star" [class.full]="fill === 100">
              <span class="half" [style.width.%]="fill">â˜…</span>â˜†
            </span>
          </ng-template>
          <ngb-rating
            [(rate)]="t.rate"
            [starTemplate]="starTemplate"
            [readonly]="false"
            [max]="5"
            (rateChange)="onRate(t.id, t.rate)">
          </ngb-rating>
        </div> -->
      </div>
    </div>
  </div>

  <div class="offcanvas-footer text-center py-3 bg-light border-top">
    <small class="text-muted">Historique des 10 derniÃ¨res traductions</small>
  </div>
</ng-template>